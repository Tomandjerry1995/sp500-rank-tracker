# file: .github/workflows/pages.yml
name: pages-daily

on:
  schedule:
    - cron: "0 0 * * *"   # 每天 UTC 00:00 = 北京时间 08:00
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package
        run: pip install -e .

      - name: Ensure folders
        run: |
          mkdir -p data docs

      - name: Fetch today's top-500
        run: python -m sp500_tracker.cli fetch --top 500 --dropped-rank 501

      - name: Migrate DB (unify any >501 -> 501)
        run: |
          python - <<'PY'
          import sqlite3, os
          db = os.path.join("data", "sp500_ranks.sqlite3")
          con = sqlite3.connect(db)
          con.execute("UPDATE rank_history SET rank=501 WHERE rank>501;")
          con.commit()
          con.close()
          print("[ok] migration >501 -> 501 done")
          PY

      - name: Build interactive plots (Top50 & Top100, include-all)
        run: |
          # Top50
          python -m sp500_tracker.cli plot --interactive --top 500 --include-all --max-lines 50 --range 1-50
          ls -t data/plots/*.html | head -n 1 | xargs -I{} cp "{}" docs/latest-50.html
          # Top100
          python -m sp500_tracker.cli plot --interactive --top 500 --include-all --max-lines 100 --range 1-100
          ls -t data/plots/*.html | head -n 1 | xargs -I{} cp "{}" docs/latest-100.html

      - name: Keep homepage
        run: |
          test -f docs/index.html || cat > docs/index.html <<'HTML'
          <!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>S&P 500 Rank Trends</title>
          <style>
            :root{--bg:#111827;--fg:#e5e7eb;--muted:#9ca3af;--border:#374151;}
            body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;margin:20px}
            .btns{display:flex;gap:8px;margin:12px 0 16px}
            button{border:1px solid var(--border);background:#1f2937;color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
            button.active{background:#2563eb;border-color:#2563eb}
            iframe{width:100%;height:80vh;border:1px solid var(--border);border-radius:12px;background:#fff}
            .meta{color:var(--muted);font-size:14px;margin-bottom:8px}
          </style></head><body>
          <h1>S&P 500 Rank Trends</h1>
          <div class="meta">Daily top-500 kept; dropped = 501. Last update (UTC): <span id="ts"></span></div>
          <div class="btns"><button id="b50" class="active">Top 50</button><button id="b100">Top 100</button></div>
          <iframe id="frame" src="latest-50.html"></iframe>
          <script>
          const ts=new Date().toISOString().replace('T',' ').replace('Z',' UTC');document.getElementById('ts').textContent=ts;
          const f=document.getElementById('frame');const b50=document.getElementById('b50');const b100=document.getElementById('b100');
          function set(x){if(x===50){b50.classList.add('active');b100.classList.remove('active');f.src='latest-50.html';}
                          else{b100.classList.add('active');b50.classList.remove('active');f.src='latest-100.html';}}
          b50.onclick=()=>set(50); b100.onclick=()=>set(100);
          </script></body></html>
          HTML
      - name: Commit docs & DB
        run: |
          set -e
          test -f data/sp500_ranks.sqlite3
          ls -lh data/sp500_ranks.sqlite3
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f data/sp500_ranks.sqlite3
          git add docs/latest-50.html docs/latest-100.html docs/index.html
          git commit -m "daily: fetch+migrate+plots+db" || echo "No changes"
          git push

